<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; text-align: center; }
        .loader { border: 5px solid #333; border-top: 5px solid #f39c12; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h3 { color: #f39c12; margin-bottom: 10px; }
        p { color: #aaa; font-size: 0.9rem; max-width: 400px; line-height: 1.5; }
        .status-box { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; border: 1px solid #444; width: 300px; }
    </style>
</head>
<body>

    <div class="status-box">
        <div class="loader"></div>
        <h3>Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù‚Ø§Ø¦Ù…ØªÙƒ ğŸ“¥</h3>
        <p id="status-text">Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³ÙŠØ±ÙØ± Ø§Ù„Ø£Ù†Ù…ÙŠ...</p>
    </div>

    <script>
        const username = "{{ username }}";
        const selectedStatuses = {{ statuses | tojson }}; 

        async function fetchMalData() {
            const statusText = document.getElementById('status-text');
            
            // 1. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± (Jikan API)
            const directUrl = `https://api.jikan.moe/v4/users/${username}/animelist?limit=300`; // Ù†Ø¶ÙŠÙ limit Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…
            
            // 2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø±ÙˆÙƒØ³ÙŠ (ÙˆÙƒÙŠÙ„) Ù„ØªØ¬Ø§ÙˆØ² Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø¸Ø± ÙˆØ§Ù„Ù€ CORS ÙÙŠ Ø§Ù„Ù€ Localhost
            // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ©
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(directUrl)}`;

            try {
                statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹Ø¨Ø± Ø§Ù„ÙˆÙƒÙŠÙ„)...";
                
                // Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙˆÙƒÙŠÙ„
                const response = await fetch(proxyUrl);
                
                if (!response.ok) throw new Error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆÙƒÙŠÙ„");
                
                const proxyData = await response.json();
                
                // Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠØ±Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ Ø§Ø³Ù…Ù‡ contents ÙƒÙ†Øµ
                if (!proxyData.contents) throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±");
                
                const jsonData = JSON.parse(proxyData.contents);
                const allAnime = jsonData.data || [];

                statusText.innerText = `ÙˆØµÙ„Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! (${allAnime.length} Ø£Ù†Ù…ÙŠ). Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ±Ø²...`;

                // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙ„ØªØ±Ø© (Ù†ÙØ³Ù‡) ---
                const validMap = {
                    'completed': ['Completed', 2],
                    'watching': ['Watching', 1],
                    'on_hold': ['On-Hold', 3],
                    'dropped': ['Dropped', 4]
                };

                let filteredIds = [];
                allAnime.forEach(item => {
                    // Jikan V4 Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ ÙŠØºÙŠØ± Ø§Ù„Ù‡ÙŠÙƒÙ„Ø©ØŒ Ù†ØªØ£ÙƒØ¯ Ù…Ù†Ù‡Ø§
                    const statusName = item.status; 
                    const animeId = item.anime.mal_id;
                    
                    let isMatch = false;
                    selectedStatuses.forEach(reqStatus => {
                        if (validMap[reqStatus] && validMap[reqStatus].includes(statusName)) {
                            isMatch = true;
                        }
                    });

                    if (isMatch) filteredIds.push(animeId);
                });

                if (filteredIds.length === 0) {
                    alert("Ø­Ø³Ø§Ø¨Ùƒ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ù…ÙŠØ§Øª ÙÙŠ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ØªÙŠ Ø§Ø®ØªØ±ØªÙ‡Ø§!");
                    window.location.href = "/";
                    return;
                }

                // --- Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ ---
                statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ø¯Ø®Ø§Ù„Ùƒ Ù„Ù„Ø¹Ø¨Ø©... ğŸš€";
                
                await fetch('/save_mal_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: filteredIds })
                });

                setTimeout(() => window.location.href = "/play?mode=mal_ready", 500);

            } catch (error) {
                console.error(error);
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø©: Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ØŒ Ù†Ø¬Ø±Ø¨ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (Ù‚Ø¯ ØªÙ†Ø¬Ø­ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹)
                statusText.innerText = "ÙØ´Ù„ Ø§Ù„ÙˆÙƒÙŠÙ„ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...";
                try {
                    const resp2 = await fetch(directUrl);
                    if(resp2.ok) {
                        const json2 = await resp2.json();
                        // ... ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ù†Ø·Ù‚ (Ø§Ø®ØªØµØ§Ø±Ø§Ù‹ØŒ Ø³Ù†Ø¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¹Ù…Ù„ Ø±ÙŠÙØ±Ø´)
                        location.reload(); 
                        return;
                    }
                } catch(e) {}

                statusText.innerHTML = `<span style="color:#e74c3c">Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}</span><br><br><button onclick="location.reload()" style="cursor:pointer; padding:5px;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ğŸ”„</button>`;
            }
        }

        // ØªØ´ØºÙŠÙ„ ÙÙˆØ±ÙŠ
        fetchMalData();
    </script>
</body>
</html>