<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; text-align: center; }
        .loader { border: 5px solid #333; border-top: 5px solid #f39c12; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-box { background: rgba(255,255,255,0.05); padding: 30px; border-radius: 15px; border: 1px solid #444; width: 350px; }
        button { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        button.retry { background: #e67e22; }
    </style>
</head>
<body>

    <div class="status-box">
        <div class="loader" id="spinner"></div>
        <h3 id="main-title" style="color:#f39c12">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h3>
        <p id="status-text">Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø£ÙˆÙ„Ø§Ù‹ ğŸš€</p>
        
        <div id="emergency-area" style="display:none; margin-top:20px; border-top:1px solid #444; padding-top:10px;">
            <p style="color:#e74c3c; font-size:0.9rem;">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.</p>
            <button onclick="forceStart()" style="background:#c0392b;">âš ï¸ ØªØ®Ø·ÙŠ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¹Ø¨Ø© ÙÙˆØ±Ø§Ù‹</button>
        </div>
    </div>

    <script>
        const username = "{{ username }}";
        const selectedStatuses = {{ statuses | tojson }}; 

        async function startSync() {
            const statusText = document.getElementById('status-text');
            const targetUrl = `https://api.jikan.moe/v4/users/${username}/animelist?limit=300`;
            
            let finalData = [];

            try {
                // 1. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± (Direct)
                // Jikan V4 ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ØŒ ÙˆÙ‡Ùˆ Ø§Ù„Ø£Ø³Ø±Ø¹
                statusText.innerText = "Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±...";
                const resp1 = await fetch(targetUrl);
                if (resp1.ok) {
                    const json1 = await resp1.json();
                    finalData = json1.data || [];
                    console.log("Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±!");
                } else {
                    throw new Error("Direct failed");
                }

            } catch (e1) {
                console.log("ÙØ´Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ØŒ Ù†Ø¬Ø±Ø¨ Ø§Ù„ÙˆÙƒÙŠÙ„...");
                // 2. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø¹Ø¨Ø± Ø§Ù„ÙˆÙƒÙŠÙ„ (Fallback)
                try {
                    statusText.innerText = "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆÙƒÙŠÙ„ Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¸Ø±...";
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
                    const resp2 = await fetch(proxyUrl);
                    if (!resp2.ok) throw new Error("Proxy failed");
                    
                    const json2 = await resp2.json();
                    if (!json2.contents) throw new Error("Empty proxy");
                    
                    const parsed = JSON.parse(json2.contents);
                    finalData = parsed.data || [];
                    console.log("Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø± Ø§Ù„ÙˆÙƒÙŠÙ„!");

                } catch (e2) {
                    // ÙØ´Ù„ ÙƒÙ„ Ø´ÙŠØ¡
                    console.error(e2);
                    showError();
                    return;
                }
            }

            // ÙˆØµÙ„Ù†Ø§ Ù‡Ù†Ø§ ÙŠØ¹Ù†ÙŠ Ù…Ø¹Ù†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª! ğŸ‰
            processAndStart(finalData);
        }

        function processAndStart(allAnime) {
            const statusText = document.getElementById('status-text');
            
            if (!allAnime || allAnime.length === 0) {
                statusText.innerHTML = "ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆÙ„ÙƒÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©!<br>Ù‡Ù„ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ MAL Ø¹Ø§Ù… (Public)ØŸ";
                document.getElementById('emergency-area').style.display = 'block';
                document.getElementById('spinner').style.display = 'none';
                return;
            }

            statusText.innerText = `ØªÙ… Ø¬Ù„Ø¨ ${allAnime.length} Ø£Ù†Ù…ÙŠ. Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ±Ø²...`;

            // ÙÙ„ØªØ±Ø© Ù…ØªØ³Ø§Ù‡Ù„Ø© Ø¬Ø¯Ø§Ù‹ (ØªÙ‚Ø¨Ù„ Ø£ÙŠ Ø´ÙŠØ¡ ÙŠØ´Ø¨Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø©)
            const normalize = (str) => String(str).toLowerCase().replace(/[\s-_]/g, '');
            
            const targetMap = {
                'completed': ['completed', '2'],
                'watching': ['watching', '1'],
                'on_hold': ['onhold', '3'],
                'dropped': ['dropped', '4']
            };

            let filteredIds = [];
            allAnime.forEach(item => {
                const s = normalize(item.status || "");
                const id = item.anime.mal_id;
                
                let isMatch = false;
                selectedStatuses.forEach(req => {
                    const valid = targetMap[req] || [];
                    if (valid.some(v => s.includes(v))) isMatch = true;
                });
                if (isMatch) filteredIds.push(id);
            });

            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ ØªØ·Ø§Ø¨Ù‚ØŒ Ù†Ø£Ø®Ø° ÙƒÙ„ Ø´ÙŠØ¡ (Ø®Ø·Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦)
            if (filteredIds.length === 0) {
                console.log("Ù„Ù… Ù†Ø¬Ø¯ ØªØ·Ø§Ø¨Ù‚ØŒ Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙ„");
                filteredIds = allAnime.map(i => i.anime.mal_id);
            }

            sendData(filteredIds);
        }

        async function sendData(ids) {
            document.getElementById('status-text').innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù„Ø¹Ø¨Ø©... ğŸ®";
            
            await fetch('/save_mal_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: ids })
            });

            setTimeout(() => window.location.href = "/play?mode=mal_ready", 500);
        }

        function showError() {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('main-title').innerText = "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„";
            document.getElementById('main-title').style.color = "#e74c3c";
            document.getElementById('status-text').innerText = "ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø¶ØºØ·Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©.";
            document.getElementById('emergency-area').style.display = 'block';
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ (Ø¨Ø¯ÙˆÙ† Ø£Ù†Ù…ÙŠØ§Øª Ù…Ø­Ø¯Ø¯Ø©ØŒ Ø³ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†)
        async function forceStart() {
            // Ù†Ø±Ø³Ù„ Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© Ù„ÙŠÙÙ‡Ù… Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ† Ø£Ù† Ø¹Ù„ÙŠÙ‡ Ø§Ù„ØªØµØ±Ù
            await fetch('/save_mal_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: [] }) // Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©
            });
            window.location.href = "/play?mode=mal_ready";
        }

        // ØªØ´ØºÙŠÙ„
        startSync();
    </script>
</body>
</html>