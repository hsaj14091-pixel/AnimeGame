<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; text-align: center; }
        .loader { border: 5px solid #333; border-top: 5px solid #f39c12; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-box { background: rgba(255,255,255,0.05); padding: 30px; border-radius: 15px; border: 1px solid #444; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h3 { color: #f39c12; margin: 0 0 15px 0; }
        p { color: #ccc; font-size: 0.9rem; margin: 0; line-height: 1.6; }
        .log { font-size: 0.8rem; color: #777; margin-top: 10px; border-top: 1px solid #333; padding-top: 5px; }
    </style>
</head>
<body>

    <div class="status-box">
        <div class="loader"></div>
        <h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</h3>
        <p id="status-text">Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙØ¶Ù„ Ø·Ø±ÙŠÙ‚ Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ“¡</p>
        <div id="log-area" class="log"></div>
    </div>

    <script>
        const username = "{{ username }}";
        const selectedStatuses = {{ statuses | tojson }}; 

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡ (Ø§Ù„Ø®Ø·Ø© Ø£ØŒ Ø¨ØŒ Ø¬)
        // ÙƒÙ„ ÙˆØ§Ø­Ø¯ Ù„Ù‡ Ø·Ø±ÙŠÙ‚Ø© Ù…Ø®ØªÙ„ÙØ© ÙÙŠ Ø§Ù„ØªØ¹Ø§Ù…Ù„
        const proxies = [
            {
                name: "Ø§Ù„ÙˆÙƒÙŠÙ„ 1 (AllOrigins)",
                url: (target) => `https://api.allorigins.win/get?url=${encodeURIComponent(target)}`,
                extract: (json) => JSON.parse(json.contents) // Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠØ¶Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ contents
            },
            {
                name: "Ø§Ù„ÙˆÙƒÙŠÙ„ 2 (CodeTabs)",
                url: (target) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(target)}`,
                extract: (json) => json // Ù‡Ø°Ø§ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙŠØ¹Ø·ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
            },
            {
                name: "Ø§Ù„ÙˆÙƒÙŠÙ„ 3 (CorsProxy)",
                url: (target) => `https://corsproxy.io/?${encodeURIComponent(target)}`,
                extract: (json) => json 
            }
        ];

        async function fetchMalData() {
            const statusText = document.getElementById('status-text');
            const logArea = document.getElementById('log-area');
            const targetUrl = `https://api.jikan.moe/v4/users/${username}/animelist?limit=300`;

            let finalData = null;

            // Ø­Ù„Ù‚Ø© ØªÙƒØ±Ø§Ø± Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡ ÙˆØ§Ø­Ø¯Ø§Ù‹ ØªÙ„Ùˆ Ø§Ù„Ø¢Ø®Ø±
            for (const proxy of proxies) {
                try {
                    statusText.innerText = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø¨Ø± ${proxy.name}...`;
                    logArea.innerText += `ØªØ¬Ø±Ø¨Ø© ${proxy.name}...\n`;
                    
                    const response = await fetch(proxy.url(targetUrl));
                    
                    if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                    
                    const rawData = await response.json();
                    finalData = proxy.extract(rawData); // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ÙˆÙƒÙŠÙ„
                    
                    if (finalData && finalData.data) {
                        logArea.innerText += `âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„!\n`;
                        break; // Ø¥Ø°Ø§ Ù†Ø¬Ø­Ù†Ø§ØŒ Ù†Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø­Ù„Ù‚Ø© ÙÙˆØ±Ø§Ù‹
                    }
                    
                } catch (e) {
                    console.error(e);
                    logArea.innerText += `âŒ ÙØ´Ù„: ${e.message}\n`;
                }
            }

            if (!finalData || !finalData.data) {
                statusText.innerHTML = `<span style="color:#e74c3c">ÙØ´Ù„Øª ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª! ğŸ˜”</span><br>ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù†Øª Ø£Ùˆ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.`;
                document.querySelector('.loader').style.display = 'none';
                return;
            }

            // --- Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„ÙØ±Ø² ---
            const allAnime = finalData.data;
            statusText.innerText = `ØªÙ… Ø¬Ù„Ø¨ ${allAnime.length} Ø£Ù†Ù…ÙŠ. Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ±Ø²...`;

            const validMap = {
                'completed': ['Completed', 2],
                'watching': ['Watching', 1],
                'on_hold': ['On-Hold', 3],
                'dropped': ['Dropped', 4]
            };

            let filteredIds = [];
            allAnime.forEach(item => {
                const statusName = item.status; 
                const animeId = item.anime.mal_id;
                
                let isMatch = false;
                selectedStatuses.forEach(reqStatus => {
                    if (validMap[reqStatus] && validMap[reqStatus].includes(statusName)) isMatch = true;
                });

                if (isMatch) filteredIds.push(animeId);
            });

            if (filteredIds.length === 0) {
                alert("Ù„Ù… Ù†Ø¬Ø¯ Ø£Ù†Ù…ÙŠØ§Øª ÙÙŠ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©!");
                window.location.href = "/";
                return;
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†
            statusText.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„... ğŸš€";
            await fetch('/save_mal_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: filteredIds })
            });

            setTimeout(() => window.location.href = "/play?mode=mal_ready", 500);
        }

        fetchMalData();
    </script>
</body>
</html>